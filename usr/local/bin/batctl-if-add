#!/bin/sh
# Set up bat0 layer 2 interface, running on layer 3 $IF.
# Connect bat0 to $BR.

NETDIR="/sys/class/net"
: ${IF:=wlan0}
: ${BR:=br-lan}

usage() {
  printf "(EE) Usage: [IF=<ifname>] [BR=<brname>] ./batctl-if-add\n"
  exit 1
}

mod_bat0_mac() {
  IFACE_ADDRESS="$NETDIR/$IF/address"
  if [ ! -f $IFACE_ADDRESS ]; then
    printf "(WW) $IFACE_ADDRESS not found\n"
    usage
  fi
  read IFACE_MAC_COLONS < $IFACE_ADDRESS
  printf "(==) MAC of %s: " "$IF"
  printf "%s\n" "$IFACE_MAC_COLONS"

  IFACE_MAC=$(echo $IFACE_MAC_COLONS | tr -d ':')
  BAT0_MAC=$(( 0x$IFACE_MAC + 1 ))
  BAT0_MAC_COLONS=$(printf "%012x" $BAT0_MAC | sed 's/../&:/g;s/:$//')
  printf "(==) MAC of bat0: %s\n" "$BAT0_MAC_COLONS"
}

mod_if() {
  ip link set $IF down
  ip link set $IF mtu 1532
  ip link set $IF up
  batctl if add $IF
  ip link set bat0 address $BAT0_MAC_COLONS
  printf "(==) Set MAC of bat0: %s\n" "$BAT0_MAC_COLONS"
  BAT0_IP=$(mac-to-ip $BAT0_MAC)
  ip -6 addr add $BAT0_IP/64 dev bat0
  ip link set bat0 up
  printf "(==) Set IP of bat0: %s\n" "$BAT0_IP"
  printf "(II) "
  ip addr show
}

# Assume $BR already up, and connected to Ethernet for internet access
mod_br() {
  brctl addif $BR bat0
  printf "(II) "
  brctl show
}

check_root() {
  if [ $USER != "root" ]; then
    printf "(EE) You must be root to run this script.\n"
    usage
  fi
}

check_root
mod_bat0_mac
mod_if
mod_br
